# Prophet Backend

FastAPIとSupabaseを使用したProphetアプリケーションのバックエンド

## 環境構築

1. 必要なパッケージのインストール:
```bash
python3.11 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

2. 環境変数の設定:
`.env`ファイルを作成し、以下の変数を設定:
```
SUPABASE_URL=https://[PROJECT-ID].supabase.co
SUPABASE_KEY=[YOUR-SUPABASE-KEY]
```

## データベーススキーマ

Supabaseで以下のSQLを実行してスキーマを設定:

```sql
-- 1. pgvectorの拡張機能を有効化
create extension if not exists vector;

-- 2. 予言テーブルの作成（メインテーブル）
create table public.prophecies (
    id uuid primary key,
    sentence text not null,
    betting_amount decimal not null,
    oracle text not null,
    target_date timestamp with time zone,
    target_dates timestamp with time zone[],
    creator text not null,
    status text default 'PENDING' check (status in ('PENDING', 'VERIFIED', 'FAILED')),
    created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. ベクトルテーブルの作成
create table public.prophecy_vectors (
    id bigint generated by default as identity primary key,
    prophecy_id uuid references public.prophecies(id) on delete cascade,
    embedding vector(1024),
    text text not null,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. 類似検索用の関数
create or replace function public.match_prophecies (
    query_embedding vector(1024),
    match_threshold float default 0.7,
    match_count int default 5
)
returns table (
    prophecy_id uuid,
    similarity float
)
language plpgsql
as $$
begin
    return query
    select
        pv.prophecy_id,
        1 - (pv.embedding <=> query_embedding) as similarity
    from public.prophecy_vectors pv
    where 1 - (pv.embedding <=> query_embedding) > match_threshold
    order by similarity desc
    limit match_count;
end;
$$;

-- 5. インデックスの作成
create index on public.prophecy_vectors 
using ivfflat (embedding vector_cosine_ops)
with (lists = 100);

-- 6. RLSの設定
alter table public.prophecies enable row level security;
alter table public.prophecy_vectors enable row level security;

-- propheciesテーブルのポリシー
create policy "Enable read access for all users" 
on public.prophecies for select 
to public
using (true);

create policy "Enable insert access for all users" 
on public.prophecies for insert 
to public
with check (true);

-- prophecy_vectorsテーブルのポリシー
create policy "Enable read access for all users"
on public.prophecy_vectors for select 
to public
using (true);

create policy "Enable insert access for all users"
on public.prophecy_vectors for insert 
to public
with check (true);

-- 7. 必要な権限の付与
grant usage on schema public to anon, authenticated;
grant all on public.prophecies to anon, authenticated;
grant all on public.prophecy_vectors to anon, authenticated;
grant execute on function public.match_prophecies to anon, authenticated;
grant usage, select on all sequences in schema public to anon, authenticated;
```

## API エンドポイント

### POST /prophecies
新しい予言を作成

リクエストボディ:
```typescript
{
    sentence: string;
    bettingAmount: number;
    oracle: string;
    targetDate?: string;
    targetDates?: string[];
    creator: string;
    roi: number;
    entryPrice: number;
    currentPrice: number;
    leverage: number;
    isShort: boolean;
    status: "PENDING" | "COMPLETED" | "FAILED";
    created_at: string;
}
```

### GET /prophecies/{prophecy_id}
指定されたIDの予言を取得

### GET /prophecies/similar/{prophecy_id}
指定された予言に類似した予言を検索

## 開発サーバーの起動

```bash
uvicorn main:app --reload
```

サーバーは http://localhost:8000 で起動します。
APIドキュメントは http://localhost:8000/docs で確認できます。 